{% extends "layout.html" %}

{% block content %}
<style>
    /* è¯è¯­æ ‡ç­¾æ ·å¼ - ç”¨é¢œè‰²è¡¨ç¤ºè¯æ€§ï¼Œæ— é—´è· */
    .word-tag {
        display: inline;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
        padding: 0;
        margin: 0;
    }
    .word-tag:hover { 
        opacity: 0.7; 
        background: rgba(0,0,0,0.05); 
    }
    
    /* è¯æ€§é¢œè‰² */
    .pos-n { color: #4a6cf7; }
    .pos-nr { color: #0dcaf0; }
    .pos-ns { color: #198754; }
    .pos-nt { color: #dc3545; }
    .pos-nz { color: #6f42c1; }
    .pos-v { color: #28a745; }
    .pos-a { color: #fd7e14; }
    .pos-d { color: #6c757d; }
    .pos-m { color: #343a40; }
    .pos-q { color: #495057; }
    .pos-r { color: #868e96; }
    .pos-p { color: #adb5bd; }
    .pos-c { color: #adb5bd; }
    .pos-u { color: #ced4da; }
    .pos-t { color: #e83e8c; }
    .pos-w { color: #dee2e6; }
    .pos-default { color: #333; }
    
    /* å‘½åå®ä½“ä¸‹åˆ’çº¿ */
    .entity-äººå { border-bottom-color: #0dcaf0; background: rgba(13,202,240,0.15); }
    .entity-åœ°å { border-bottom-color: #198754; background: rgba(25,135,84,0.15); }
    .entity-ç»„ç»‡ { border-bottom-color: #dc3545; background: rgba(220,53,69,0.15); }
    .entity-æ—¶é—´ { border-bottom-color: #6f42c1; background: rgba(111,66,193,0.15); }
    .entity-æƒ…æ„Ÿ { border-bottom-color: #fd7e14; background: rgba(253,126,20,0.15); }

    /* æ–‡æœ¬å®¹å™¨ - è°ƒå¤§ */
    #text-container {
        font-size: 1.1rem;
        line-height: 1.9;
        padding: 20px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px 8px 0 0;
        min-height: 380px;
        max-height: 480px;
        overflow-y: auto;
    }

    /* å›¾ä¾‹æ ·å¼ - è°ƒå¤§ */
    .legend-container {
        padding: 14px 18px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 0 0 8px 8px;
        border: 1px solid #e0e0e0;
        border-top: none;
    }
    .legend-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 10px;
    }
    .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
        gap: 5px;
    }
    .legend-color {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    .legend-underline {
        display: inline-block;
        padding: 3px 10px;
        border-bottom: 2px solid;
        font-size: 0.85rem;
        border-radius: 3px;
    }

    /* å³ä¾§è¯è¯­åˆ—è¡¨ - è¡Œè·å°ä¸€ç‚¹ */
    .word-list-container {
        max-height: 720px;
        overflow-y: auto;
    }
    .word-item {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }
    .word-item:hover { background: #f8f9fa; }
    .word-item .word-text { font-weight: 600; min-width: 50px; font-size: 0.95rem; }
    .word-item .word-pos { font-size: 0.75em; color: #666; }
    .word-item .word-entity {
        font-size: 0.7em;
        padding: 2px 8px;
        border-radius: 12px;
        color: #fff;
    }
    
    /* å®ä½“æ ‡ç­¾é¢œè‰² */
    .entity-badge-äººå { background: #0dcaf0; }
    .entity-badge-åœ°å { background: #198754; }
    .entity-badge-ç»„ç»‡ { background: #dc3545; }
    .entity-badge-æ—¶é—´ { background: #6f42c1; }
    .entity-badge-æƒ…æ„Ÿ { background: #fd7e14; }

    /* æ•´ä½“æ ‡æ³¨åŒºåŸŸ - é«˜åº¦å°ä¸€ç‚¹ */
    .text-annotation-card { background: #f8f9fa; }
    .text-annotation-card .card-body { padding: 16px 20px; }
    .text-annotation-card .row.g-4 { --bs-gutter-y: 0.8rem; }
    .text-annotation-card .form-label { margin-bottom: 10px; }
    
    /* å¹³é“ºé€‰æ‹©æŒ‰é’®æ ·å¼ */
    .tag-btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .tag-btn {
        padding: 6px 14px;
        border-radius: 18px;
        border: 2px solid #e0e0e0;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .tag-btn:hover {
        border-color: #4a6cf7;
        background: rgba(74, 108, 247, 0.05);
        transform: translateY(-1px);
    }
    .tag-btn.active {
        border-color: #4a6cf7;
        background: #4a6cf7;
        color: #fff;
        box-shadow: 0 2px 6px rgba(74, 108, 247, 0.3);
    }
    
    /* æƒ…æ„ŸæŒ‰é’®ç‰¹æ®Šæ ·å¼ */
    .tag-btn.sentiment-positive.active { background: #28a745; border-color: #28a745; box-shadow: 0 2px 6px rgba(40,167,69,0.3); }
    .tag-btn.sentiment-neutral.active { background: #6c757d; border-color: #6c757d; box-shadow: 0 2px 6px rgba(108,117,125,0.3); }
    .tag-btn.sentiment-negative.active { background: #dc3545; border-color: #dc3545; box-shadow: 0 2px 6px rgba(220,53,69,0.3); }
    
    /* å·¦å³å¸ƒå±€ */
    .annotation-row { 
        display: flex; 
        min-height: 780px;
    }
    .left-col { 
        display: flex; 
        flex-direction: column; 
    }
    .left-col .card:first-child {
        flex: 1;
    }
    
    /* å³ä¾§å¡ç‰‡æ’‘æ»¡ */
    .right-col .card {
        height: 100%;
    }
    
    /* å¡ç‰‡ç¾åŒ– */
    .card {
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: none;
    }
    .card-header {
        border-bottom: 1px solid #eee;
    }
</style>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="bi bi-file-text-fill text-primary me-2"></i> {{ file.filename }}</h2>
            <p class="text-muted mb-0">å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€è¯æ€§å’Œå‘½åå®ä½“æ ‡æ³¨</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" id="smartAnnotateBtn" onclick="smartAnnotate()">
                <i class="bi bi-magic me-1"></i> æ™ºèƒ½æ ‡æ³¨
            </button>
            <button class="btn btn-success" onclick="saveAllAnnotations()">
                <i class="bi bi-save me-1"></i> ä¿å­˜æ ‡æ³¨
            </button>
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> è¿”å›
            </a>
        </div>
    </div>
</div>

<div class="row annotation-row">
    <!-- å·¦ä¾§åŒºåŸŸ - åŠ å®½ -->
    <div class="col-lg-9 left-col">
        <!-- æ–‡æœ¬å†…å®¹åŒºï¼ˆå·¦ä¸Šï¼‰ -->
        <div class="card mb-3">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0"><i class="bi bi-text-paragraph text-primary me-2"></i>æ–‡æœ¬å†…å®¹
                    <small class="text-muted ms-2">ï¼ˆç‚¹å‡»è¯è¯­å¯ç¼–è¾‘å®ä½“ç±»å‹ï¼‰</small>
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="text-container"></div>
                
                <!-- é¢œè‰²å›¾ä¾‹ -->
                <div class="legend-container">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="legend-title">ğŸ“ è¯æ€§é¢œè‰²è¯´æ˜</div>
                            <div class="legend-items">
                                <span class="legend-item"><span class="legend-color" style="background:#4a6cf7;"></span>åè¯</span>
                                <span class="legend-item"><span class="legend-color" style="background:#28a745;"></span>åŠ¨è¯</span>
                                <span class="legend-item"><span class="legend-color" style="background:#fd7e14;"></span>å½¢å®¹è¯</span>
                                <span class="legend-item"><span class="legend-color" style="background:#6c757d;"></span>å‰¯è¯</span>
                                <span class="legend-item"><span class="legend-color" style="background:#e83e8c;"></span>æ—¶é—´è¯</span>
                                <span class="legend-item"><span class="legend-color" style="background:#343a40;"></span>æ•°é‡è¯</span>
                                <span class="legend-item"><span class="legend-color" style="background:#adb5bd;"></span>è™šè¯</span>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="legend-title">ğŸ·ï¸ å‘½åå®ä½“æ ‡æ³¨</div>
                            <div class="legend-items">
                                <span class="legend-underline entity-äººå">äººå</span>
                                <span class="legend-underline entity-åœ°å">åœ°å</span>
                                <span class="legend-underline entity-ç»„ç»‡">ç»„ç»‡</span>
                                <span class="legend-underline entity-æ—¶é—´">æ—¶é—´</span>
                                <span class="legend-underline entity-æƒ…æ„Ÿ">æƒ…æ„Ÿ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ–‡æœ¬æ•´ä½“æ ‡æ³¨ï¼ˆå·¦ä¸‹ï¼‰ -->
        <div class="card text-annotation-card">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0"><i class="bi bi-tags text-primary me-2"></i>æ–‡æœ¬æ•´ä½“æ ‡æ³¨</h6>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-12">
                        <label class="form-label fw-bold mb-3">æ–‡æœ¬åˆ†ç±»</label>
                        <div class="tag-btn-group" id="category-group">
                            <button type="button" class="tag-btn" data-value="æ–°é—»" onclick="selectCategory(this)">ğŸ“° æ–°é—»</button>
                            <button type="button" class="tag-btn" data-value="ç§‘æŠ€" onclick="selectCategory(this)">ğŸ’» ç§‘æŠ€</button>
                            <button type="button" class="tag-btn" data-value="è´¢ç»" onclick="selectCategory(this)">ğŸ’° è´¢ç»</button>
                            <button type="button" class="tag-btn" data-value="ä½“è‚²" onclick="selectCategory(this)">âš½ ä½“è‚²</button>
                            <button type="button" class="tag-btn" data-value="å¨±ä¹" onclick="selectCategory(this)">ğŸ¬ å¨±ä¹</button>
                            <button type="button" class="tag-btn" data-value="æ•™è‚²" onclick="selectCategory(this)">ğŸ“š æ•™è‚²</button>
                            <button type="button" class="tag-btn" data-value="å¥åº·" onclick="selectCategory(this)">ğŸ¥ å¥åº·</button>
                            <button type="button" class="tag-btn" data-value="å…¶ä»–" onclick="selectCategory(this)">ğŸ“ å…¶ä»–</button>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold mb-3">æ–‡æœ¬æƒ…æ„Ÿ</label>
                        <div class="tag-btn-group" id="sentiment-group">
                            <button type="button" class="tag-btn sentiment-positive" data-value="ç§¯æ" onclick="selectSentiment(this)">ğŸ˜Š ç§¯æ</button>
                            <button type="button" class="tag-btn sentiment-neutral" data-value="ä¸­æ€§" onclick="selectSentiment(this)">ğŸ˜ ä¸­æ€§</button>
                            <button type="button" class="tag-btn sentiment-negative" data-value="æ¶ˆæ" onclick="selectSentiment(this)">ğŸ˜ æ¶ˆæ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§è¯è¯­æ ‡æ³¨åˆ—è¡¨ - å˜çª„ -->
    <div class="col-lg-3 right-col">
        <div class="card">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-ul text-primary me-2"></i>è¯è¯­æ ‡æ³¨</h6>
                <span class="badge bg-primary" id="word-count">0 è¯</span>
            </div>
            <div class="card-body p-0 word-list-container" id="word-list">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-info-circle fs-1 mb-2 d-block opacity-25"></i>
                    <p>ç‚¹å‡»"æ™ºèƒ½æ ‡æ³¨"è¿›è¡Œåˆ†è¯å’Œæ ‡æ³¨</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å®ä½“é€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="entityModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2" style="background: linear-gradient(135deg, #4a6cf7, #6c75f5); color: white;">
                <h6 class="modal-title mb-0">
                    <i class="bi bi-tag me-2"></i>é€‰æ‹©å®ä½“ç±»å‹
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="hidden" id="current-word-index">
                <p class="text-center mb-3">
                    å½“å‰è¯è¯­ï¼š<strong id="current-word-text" class="text-primary fs-5"></strong>
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-info text-white" onclick="setEntity('äººå')">ğŸ‘¤ äººå</button>
                    <button class="btn btn-success" onclick="setEntity('åœ°å')">ğŸ“ åœ°å</button>
                    <button class="btn btn-danger" onclick="setEntity('ç»„ç»‡')">ğŸ¢ ç»„ç»‡</button>
                    <button class="btn text-white" style="background:#6f42c1" onclick="setEntity('æ—¶é—´')">â° æ—¶é—´</button>
                    <button class="btn btn-warning" onclick="setEntity('æƒ…æ„Ÿ')">ğŸ’– æƒ…æ„Ÿ</button>
                    <hr class="my-2">
                    <button class="btn btn-outline-secondary" onclick="setEntity(null)">
                        <i class="bi bi-x-circle me-1"></i>æ¸…é™¤å®ä½“
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä½¿ç”¨ script æ ‡ç­¾å®‰å…¨ä¼ é€’æ•°æ® -->
<script id="file-data" type="application/json">
{
    "fileId": {{ file.id }},
    "rawText": {{ file.content | tojson }},
    "textAnn": {
        "category": {{ (text_ann.text_category if text_ann and text_ann.text_category else "") | tojson }},
        "sentiment": {{ (text_ann.text_sentiment if text_ann and text_ann.text_sentiment else "") | tojson }}
    },
    "wordAnns": [
        {% if word_anns %}
        {% for w in word_anns %}
        {
            "id": {{ w.id }},
            "index": {{ w.word_index }},
            "word": {{ w.word | tojson }},
            "pos": {{ (w.pos or "") | tojson }},
            "pos_cn": {{ (w.pos_cn or "") | tojson }},
            "entity_label": {{ (w.entity_label or "") | tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
    ]
}
</script>

<script>
// å®‰å…¨åœ°ä» JSON è„šæœ¬æ ‡ç­¾è·å–æ•°æ®
const fileData = JSON.parse(document.getElementById('file-data').textContent);
const fileId = fileData.fileId;
const rawText = fileData.rawText;

let wordAnnotations = [];
let selectedCategory = '';
let selectedSentiment = '';
let hasChanges = false;
let entityModal;

document.addEventListener('DOMContentLoaded', function() {
    entityModal = new bootstrap.Modal(document.getElementById('entityModal'));
    
    // åˆå§‹æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
    displayRawText();
    
    // åŠ è½½å·²æœ‰æ ‡æ³¨
    if (fileData.wordAnns && fileData.wordAnns.length > 0) {
        wordAnnotations = fileData.wordAnns.map(w => ({
            id: w.id,  // æ·»åŠ è¿™è¡Œ
            index: w.index,
            word: w.word,
            pos: w.pos,
            pos_cn: w.pos_cn,
            entity_label: w.entity_label || null
        }));
        renderAll();
    }
    
    // è®¾ç½®å·²æœ‰çš„æ–‡æœ¬æ•´ä½“æ ‡æ³¨
    if (fileData.textAnn.category) {
        setInitialCategory(fileData.textAnn.category);
    }
    if (fileData.textAnn.sentiment) {
        setInitialSentiment(fileData.textAnn.sentiment);
    }
});

// æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
function displayRawText() {
    const container = document.getElementById('text-container');
    const escapedText = rawText
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');
    container.innerHTML = `<div style="color:#333;">${escapedText}</div>`;
}

// è®¾ç½®åˆå§‹åˆ†ç±»
function setInitialCategory(value) {
    if (!value) return;
    selectedCategory = value;
    document.querySelectorAll('#category-group .tag-btn').forEach(btn => {
        if (btn.dataset.value === value) {
            btn.classList.add('active');
        }
    });
}

// è®¾ç½®åˆå§‹æƒ…æ„Ÿ
function setInitialSentiment(value) {
    if (!value) return;
    selectedSentiment = value;
    document.querySelectorAll('#sentiment-group .tag-btn').forEach(btn => {
        if (btn.dataset.value === value) {
            btn.classList.add('active');
        }
    });
}

// é€‰æ‹©åˆ†ç±»
function selectCategory(btn) {
    document.querySelectorAll('#category-group .tag-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedCategory = btn.dataset.value;
    markChanged();
}

// é€‰æ‹©æƒ…æ„Ÿ
function selectSentiment(btn) {
    document.querySelectorAll('#sentiment-group .tag-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedSentiment = btn.dataset.value;
    markChanged();
}

// æ™ºèƒ½æ ‡æ³¨
function smartAnnotate() {
    const btn = document.getElementById('smartAnnotateBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>æ ‡æ³¨ä¸­...';
    
    fetch(`/api/smart_annotate/${fileId}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            wordAnnotations = data.word_annotations;
            
            if (data.text_annotation && data.text_annotation.category) {
                setInitialCategory(data.text_annotation.category);
            }
            if (data.text_annotation && data.text_annotation.sentiment) {
                setInitialSentiment(data.text_annotation.sentiment);
            }
            
            renderAll();
            hasChanges = true;
        } else {
            alert('æ ‡æ³¨å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(err => {
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(err);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic me-1"></i> æ™ºèƒ½æ ‡æ³¨';
    });
}

// æ¸²æŸ“æ‰€æœ‰å†…å®¹
function renderAll() {
    renderTextContainer();
    renderWordList();
}

// æ¸²æŸ“æ–‡æœ¬å®¹å™¨
function renderTextContainer() {
    const container = document.getElementById('text-container');
    
    if (!wordAnnotations || wordAnnotations.length === 0) {
        displayRawText();
        return;
    }
    
    let html = '<div>';
    wordAnnotations.forEach((w, idx) => {
        const posClass = getPosColorClass(w.pos);
        const entityClass = w.entity_label ? `entity-${w.entity_label}` : '';
        const title = (w.pos_cn || '') + (w.entity_label ? ' | ' + w.entity_label : '');
        const escapedWord = w.word
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        html += `<span class="word-tag ${posClass} ${entityClass}" 
                       data-index="${idx}" 
                       title="${title}"
                       onclick="openEntityModal(${idx})">${escapedWord}</span>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

// æ¸²æŸ“è¯è¯­åˆ—è¡¨
function renderWordList() {
    const container = document.getElementById('word-list');
    document.getElementById('word-count').textContent = (wordAnnotations ? wordAnnotations.length : 0) + ' è¯';
    
    if (!wordAnnotations || wordAnnotations.length === 0) {
        container.innerHTML = `<div class="text-center py-5 text-muted">
            <i class="bi bi-info-circle fs-1 mb-2 d-block opacity-25"></i>
            <p>ç‚¹å‡»"æ™ºèƒ½æ ‡æ³¨"è¿›è¡Œåˆ†è¯å’Œæ ‡æ³¨</p>
        </div>`;
        return;
    }
    
    let html = '';
    wordAnnotations.forEach((w, idx) => {
        const escapedWord = w.word
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        const entityBadge = w.entity_label 
            ? `<span class="word-entity entity-badge-${w.entity_label}">${w.entity_label}</span>`
            : '<span class="text-muted" style="font-size:0.75em">-</span>';
        
        html += `<div class="word-item" data-index="${idx}">
            <div>
                <span class="word-text">${escapedWord}</span>
                <span class="word-pos">${w.pos_cn || ''}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                ${entityBadge}
                <button class="btn btn-sm btn-outline-primary border-0 p-1" onclick="openEntityModal(${idx})" title="ç¼–è¾‘å®ä½“">
                    <i class="bi bi-pencil"></i>
                </button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

// è·å–è¯æ€§é¢œè‰²ç±»
function getPosColorClass(pos) {
    if (!pos) return 'pos-default';
    const map = {
        'n': 'pos-n', 'nr': 'pos-nr', 'ns': 'pos-ns', 'nt': 'pos-nt',
        'nz': 'pos-nz', 'v': 'pos-v', 'vd': 'pos-v', 'vn': 'pos-v',
        'a': 'pos-a', 'ad': 'pos-a', 'd': 'pos-d', 'm': 'pos-m',
        'q': 'pos-q', 'r': 'pos-r', 'p': 'pos-p', 'c': 'pos-c',
        'u': 'pos-u', 'w': 'pos-w', 'x': 'pos-w', 't': 'pos-t'
    };
    return map[pos] || 'pos-default';
}

// æ‰“å¼€å®ä½“é€‰æ‹©æ¨¡æ€æ¡†
function openEntityModal(wordIndex) {
    if (!wordAnnotations || wordIndex >= wordAnnotations.length) return;
    
    const word = wordAnnotations[wordIndex];
    document.getElementById('current-word-index').value = wordIndex;
    document.getElementById('current-word-text').textContent = word.word;
    entityModal.show();
}

// è®¾ç½®å®ä½“
function setEntity(label) {
    const wordIndex = parseInt(document.getElementById('current-word-index').value);
    if (wordAnnotations && wordIndex < wordAnnotations.length) {
        wordAnnotations[wordIndex].entity_label = label;
        renderAll();
        markChanged();
    }
    entityModal.hide();
}

// æ ‡è®°æœ‰æ›´æ”¹
function markChanged() {
    hasChanges = true;
}

// ä¿å­˜æ‰€æœ‰æ ‡æ³¨
function saveAllAnnotations() {
    if (!wordAnnotations || wordAnnotations.length === 0) {
        alert('è¯·å…ˆè¿›è¡Œæ™ºèƒ½æ ‡æ³¨');
        return;
    }
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';
    
    fetch('/api/save_all_annotations', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            file_id: fileId,
            text_category: selectedCategory,
            text_sentiment: selectedSentiment,
            word_annotations: wordAnnotations
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            hasChanges = false;
            alert('ä¿å­˜æˆåŠŸï¼');
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(err => {
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(err);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save me-1"></i> ä¿å­˜æ ‡æ³¨';
    });
}

// ç¦»å¼€æç¤º
window.addEventListener('beforeunload', function(e) {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>

{% endblock %}